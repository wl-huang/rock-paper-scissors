<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>çŒœæ‹³ï¼ˆé¦¬å¯å¤«éˆ AIï¼‰</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans CJK TC", "å¾®è»Ÿæ­£é»‘é«”", Arial; padding: 1.2rem; background:#f6f8fa; color:#222; }
    .container { max-width:920px; margin:0 auto; background:#fff; padding:1.2rem; border-radius:10px; box-shadow:0 6px 18px rgba(30,30,30,0.06); }
    .choices { display:flex; gap:0.6rem; margin:1rem 0; }
    .choice-btn { flex:1; padding:0.75rem; border-radius:8px; border:1px solid #ddd; background:linear-gradient(#fff,#f2f4f7); cursor:pointer; font-size:1.05rem; font-weight:600; }
    .result { margin-top:1rem; padding:0.75rem; border-radius:8px; border:1px dashed #e4e7eb; background:#fcfdff; }
    .small { font-size:0.85rem; color:#666; }
    .settings { margin-top:0.75rem; display:flex; gap:0.6rem; align-items:center; flex-wrap:wrap; }
    .scoreboard { display:flex; gap:0.8rem; margin-top:1rem; }
    .score-box { flex:1; padding:0.6rem; border-radius:8px; background:#f8fafc; border:1px solid #eef2f7; text-align:center; }
    .log { margin-top:1rem; max-height:220px; overflow:auto; padding:0.6rem; background:#fafafa; border-radius:8px; border:1px solid #eee; font-size:0.95rem; white-space:pre-wrap; }
    label { font-size:0.9rem; color:#333; }
    input[type="number"] { width:6rem; padding:0.2rem; }
    .explain { margin-top:0.8rem; padding:0.8rem; border-radius:8px; background:#fffaf0; border:1px solid #f0e6cc; color:#3a3a3a; }
    .muted { color:#666; font-size:0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>çŒœæ‹³éŠæˆ²ï¼ˆé¦¬å¯å¤«éˆ AIï¼‰</h1>
    <p class="small">AI æ ¹æ“šä½ ä¸Šä¸€æ‰‹çš„è½‰ç§»æ©Ÿç‡ä¼°è¨ˆä¸‹ä¸€æ‰‹ï¼Œä¸¦å¯é¸æ“‡æ··åˆå›æ‡‰æˆ–ç›´æ¥ååˆ¶æœ€å¯èƒ½æ‰‹å‹¢ã€‚</p>

    <div class="settings">
      <label>å¹³æ»‘ Î±ï¼š<input id="alpha" type="number" step="0.1" min="0" value="1" /></label>
      <label>æ¢ç´¢ç‡ Îµï¼š<input id="epsilon" type="number" step="0.01" min="0" max="1" value="0.12" /></label>
      <label>è¨˜æ†¶ä¸Šé™ï¼ˆæœ€å¤§è¨˜éŒ„é•·åº¦ï¼‰ï¼š<input id="maxHist" type="number" min="10" value="200" /></label>
      <label>å›æ‡‰æ¨¡å¼ï¼š
        <select id="responseMode">
          <option value="mixed">æ··åˆå›æ‡‰ï¼ˆæŒ‰æ¢ä»¶æ©Ÿç‡æ··åˆé¸æ“‡ï¼‰</option>
          <option value="max">å°æœ€å¤§è€…ç¡¬æ€§ååˆ¶ï¼ˆargmaxï¼‰</option>
        </select>
      </label>
      <button id="apply">å¥—ç”¨</button>
    </div>

    <div class="explain">
      <strong>åƒæ•¸èªªæ˜ï¼ˆç°¡æ˜ï¼‰</strong>
      <div class="muted">
        å¹³æ»‘ Î±ï¼ˆalphaï¼‰ï¼šç•¶æˆ‘å€‘è¨ˆç®—ã€Œåœ¨ä¸Šä¸€æ‰‹ç‚º i æ™‚ï¼Œä¸‹ä¸€æ‰‹ç‚º j çš„æ¢ä»¶æ©Ÿç‡ã€æ™‚ï¼Œæˆ‘å€‘æœƒæŠŠè¨ˆæ•¸åŠ ä¸Šå¹³æ»‘å¸¸æ•¸ Î±ï¼Œé¿å…æŸäº›è½‰ç§»åœ¨è³‡æ–™ä¸è¶³æ™‚è®Šæˆ 0ã€‚è‹¥åœ¨ä¸Šä¸€æ‰‹ i çš„è¨ˆæ•¸ç‚º C_{ij}ï¼Œæˆ‘å€‘ä¼°è¨ˆï¼š
        <div style="margin-top:6px; margin-bottom:6px;">
          LaTeX: P(\text{next}=j \mid \text{prev}=i) = \dfrac{C_{ij} + \alpha}{\sum_{k}(C_{ik} + \alpha)}
        </div>
        å¯¦å‹™å»ºè­°ï¼šè‹¥å¸Œæœ› AI åœ¨è³‡æ–™å°‘æ™‚è¼ƒä¸ç¢ºå®šï¼Œå¯ç”¨ Î±=1ï¼ˆåŠ ä¸€å¹³æ»‘ï¼‰ï¼›è‹¥æƒ³è®“ AI æ›´å¿«ä¾ç…§å¯¦éš›è¨ˆæ•¸ï¼Œå¯ç”¨è¼ƒå°çš„ Î±ï¼ˆä¾‹å¦‚ 0.1ï¼‰ã€‚
      </div>

      <div class="muted" style="margin-top:8px;">
        æ¢ç´¢ç‡ Îµï¼ˆepsilonï¼‰ï¼šAI ä»¥ Îµ çš„æ©Ÿç‡ã€Œéš¨æ©Ÿå‡ºæ‹³ã€ä»¥å¢åŠ ä¸ç¢ºå®šæ€§ã€é¿å…è¢«ç©å®¶é•·æœŸååˆ¶ï¼›ä»¥ 1-Îµ çš„æ©Ÿç‡ä½¿ç”¨é¦¬å¯å¤«æ©Ÿç‡åšæ±ºç­–ã€‚å¯¦å‹™å»ºè­°ï¼šÎµ å¯è¨­ 0.05ï½0.2 ä¹‹é–“ï¼ˆè¼ƒé«˜æœƒæ›´éš¨æ©Ÿï¼‰ã€‚
      </div>
    </div>

    <div class="choices" role="group" aria-label="å‡ºæ‹³é¸æ“‡">
      <button class="choice-btn" data-move="scissors">âœŒï¸ å‰ªåˆ€</button>
      <button class="choice-btn" data-move="rock">ğŸª¨ çŸ³é ­</button>
      <button class="choice-btn" data-move="paper">ğŸ§» å¸ƒ</button>
    </div>

    <div class="result" id="result">
      <div id="roundInfo">å°šæœªé–‹å§‹</div>
      <div id="who" style="font-weight:700; margin-top:0.4rem;"></div>
      <div id="aiInfo" style="margin-top:0.5rem; font-size:0.95rem; color:#333;"></div>
    </div>

    <div class="scoreboard">
      <div class="score-box"><div class="small">ä½ ï¼ˆç©å®¶ï¼‰</div><div id="playerScore" style="font-size:1.3rem; font-weight:700;">0</div></div>
      <div class="score-box"><div class="small">å¹³æ‰‹</div><div id="drawScore" style="font-size:1.3rem; font-weight:700;">0</div></div>
      <div class="score-box"><div class="small">é›»è…¦</div><div id="computerScore" style="font-size:1.3rem; font-weight:700;">0</div></div>
    </div>

    <button id="resetBtn" style="margin-top:0.8rem;">é‡è¨­æ¯”åˆ†èˆ‡ AI ç´€éŒ„</button>

    <div class="log" id="log"><div class="small">éŠæˆ²ç´€éŒ„ï¼ˆæœ€è¿‘è¨˜éŒ„ï¼‰</div></div>
  </div>

  <script>
    const moves = ['scissors','rock','paper'];
    const labels = { 'scissors': 'å‰ªåˆ€ âœŒï¸', 'rock': 'çŸ³é ­ ğŸª¨', 'paper': 'å¸ƒ ğŸ§»' };

    // DOM
    const alphaInput = document.getElementById('alpha');
    const epsilonInput = document.getElementById('epsilon');
    const maxHistInput = document.getElementById('maxHist');
    const responseModeEl = document.getElementById('responseMode');
    const applyBtn = document.getElementById('apply');
    const resetBtn = document.getElementById('resetBtn');

    const roundInfoEl = document.getElementById('roundInfo');
    const whoEl = document.getElementById('who');
    const aiInfoEl = document.getElementById('aiInfo');
    const logEl = document.getElementById('log');
    const playerScoreEl = document.getElementById('playerScore');
    const computerScoreEl = document.getElementById('computerScore');
    const drawScoreEl = document.getElementById('drawScore');

    // åƒæ•¸
    let alpha = parseFloat(alphaInput.value) || 1.0;
    let epsilon = parseFloat(epsilonInput.value) || 0.12;
    let maxHist = parseInt(maxHistInput.value, 10) || 200;
    let responseMode = responseModeEl.value; // 'mixed' or 'max'

    // è¨˜éŒ„
    let playerScore = 0, computerScore = 0, drawScore = 0;
    let playerHistory = []; // é€£çºŒç©å®¶æ‰‹å‹¢è¨˜éŒ„
    const transitionCounts = {
      'scissors': {'scissors':0,'rock':0,'paper':0},
      'rock': {'scissors':0,'rock':0,'paper':0},
      'paper': {'scissors':0,'rock':0,'paper':0}
    };
    let prevPlayer = null; // ä¸Šä¸€æ‰‹ï¼ˆæœ€åˆç‚º nullï¼‰
    const historyLog = [];

    function decideOutcome(player, comp) {
      if (player === comp) return 'draw';
      const winPairs = {'scissors':'paper','rock':'scissors','paper':'rock'};
      return winPairs[player] === comp ? 'win' : 'lose';
    }
    function randomMove() { return moves[Math.floor(Math.random()*moves.length)]; }

    function updateTransition(prev, cur) {
      if (prev === null) return;
      if (transitionCounts[prev] && transitionCounts[prev].hasOwnProperty(cur)) {
        transitionCounts[prev][cur] += 1;
      }
    }

    function getConditionalProbs(prev) {
      const counts = transitionCounts[prev];
      const probs = {};
      let total = 0;
      for (const m of moves) {
        probs[m] = (counts[m] || 0) + alpha;
        total += probs[m];
      }
      for (const m of moves) probs[m] = probs[m] / total;
      return probs;
    }

    // AI é¸æ“‡ï¼ˆä½¿ç”¨é¦¬å¯å¤«éˆï¼‰ï¼Œæ¥æ”¶ prev ä½œç‚ºä¸Šä¸€æ‰‹ï¼ˆå¯èƒ½ç‚º nullï¼‰
    function aiChoose(prev) {
      // å¦‚æœæ²’æœ‰ä¸Šä¸€æ‰‹æˆ–ä»¥ epsilon æ¢ç´¢ -> éš¨æ©Ÿ
      if (prev === null || Math.random() < epsilon) {
        return { move: randomMove(), mode: 'random' };
      }

      const probs = getConditionalProbs(prev); // P(next | prev)

      if (responseMode === 'max') {
        let maxP = -1;
        const cands = [];
        for (const m of moves) {
          const p = probs[m];
          if (p > maxP + 1e-12) { maxP = p; cands.length = 0; cands.push(m); }
          else if (Math.abs(p - maxP) < 1e-12) { cands.push(m); }
        }
        const predicted = cands[Math.floor(Math.random()*cands.length)];
        const counter = { 'scissors':'rock', 'rock':'paper', 'paper':'scissors' };
        return { move: counter[predicted], mode: 'max', probs, predicted };
      } else {
        const counter = { 'scissors':'rock', 'rock':'paper', 'paper':'scissors' };
        const aiWeights = { 'scissors':0, 'rock':0, 'paper':0 };
        for (const j of moves) {
          const aiMove = counter[j];
          aiWeights[aiMove] += probs[j];
        }
        // æŠ½æ¨£
        const r = Math.random();
        let cum = 0;
        for (const m of moves) {
          cum += aiWeights[m];
          if (r <= cum + 1e-12) return { move: m, mode:'mixed', probs, aiWeights };
        }
        return { move: randomMove(), mode:'mixed', probs, aiWeights };
      }
    }

    // playRoundï¼šç©å®¶å‡º playerMove
    function playRound(playerMove) {
      // åœ¨æ›´æ–° transition èˆ‡ prevPlayer ä¹‹å‰ï¼Œç”¨ã€Œä¸Šä¸€æ‰‹ prevPlayerã€è®“ AI åšé æ¸¬
      const prev = prevPlayer; // prev æ˜¯ã€Œä¸Šä¸€æ‰‹ã€ï¼ˆå¯èƒ½ç‚º nullï¼‰
      const aiDec = aiChoose(prev);
      const compMove = aiDec.move;

      // æ›´æ–° transitionCountsï¼ˆprev -> currentï¼‰
      updateTransition(prev, playerMove);
      // è¨˜éŒ„ playerHistory èˆ‡æ›´æ–° prevPlayer
      playerHistory.push(playerMove);
      if (playerHistory.length > maxHist) playerHistory.shift();
      prevPlayer = playerMove;

      const outcome = decideOutcome(playerMove, compMove);
      if (outcome === 'win') playerScore++;
      else if (outcome === 'lose') computerScore++;
      else drawScore++;

      // æ›´æ–° UI
      playerScoreEl.textContent = playerScore;
      computerScoreEl.textContent = computerScore;
      drawScoreEl.textContent = drawScore;

      roundInfoEl.textContent = `ä½ å‡º labels[playerMove]ï¼Œé›»è…¦å‡º{labels[playerMove]}ï¼Œé›»è…¦å‡ºlabels[playerMove]ï¼Œé›»è…¦å‡º{labels[compMove]}ã€‚`;
      if (outcome === 'win') { whoEl.textContent = 'ä½ è´äº† ğŸ‰'; whoEl.style.color = '#0b8457'; }
      else if (outcome === 'lose') { whoEl.textContent = 'ä½ è¼¸äº† ğŸ˜'; whoEl.style.color = '#c62828'; }
      else { whoEl.textContent = 'å¹³æ‰‹ ğŸ¤'; whoEl.style.color = '#444'; }

      // AI è³‡è¨Šé¡¯ç¤º
      if (aiDec.mode === 'random') {
        aiInfoEl.textContent = `AI ä½¿ç”¨éš¨æ©Ÿç­–ç•¥ï¼ˆæ¢ç´¢æˆ–ç„¡ä¸Šä¸€æ‰‹ï¼‰ã€‚`;
      } else if (aiDec.mode === 'max') {
        const p = aiDec.probs;
        aiInfoEl.textContent = `AI é æ¸¬ä½ åœ¨ä¸Šä¸€æ‰‹å¾Œçš„æ¢ä»¶æ©Ÿç‡ï¼šå‰ªåˆ€ (p.scissorsâˆ—100).toFixed(1){(p.scissors*100).toFixed(1)}%ã€çŸ³é ­(p.scissorsâˆ—100).toFixed(1){(p.rock*100).toFixed(1)}%ã€å¸ƒ (p.paperâˆ—100).toFixed(1){(p.paper*100).toFixed(1)}%ï¼›AI å°æœ€å¤§è€…ç¡¬æ€§ååˆ¶(p.paperâˆ—100).toFixed(1){labels[compMove]}ã€‚`;
      } else if (aiDec.mode === 'mixed') {
        const p = aiDec.probs;
        const w = aiDec.aiWeights;
        aiInfoEl.textContent = `AI æ ¹æ“šä¸Šä¸€æ‰‹æ··åˆå›æ‡‰ã€‚ç©å®¶æ¢ä»¶æ©Ÿç‡ï¼šå‰ªåˆ€ (p.scissorsâˆ—100).toFixed(1){(p.scissors*100).toFixed(1)}%ã€çŸ³é ­(p.scissorsâˆ—100).toFixed(1){(p.rock*100).toFixed(1)}%ã€å¸ƒ (p.paperâˆ—100).toFixed(1){(p.paper*100).toFixed(1)}%ã€‚AI å‡ºæ‹³æ¬Šé‡ï¼šå‰ªåˆ€(p.paperâˆ—100).toFixed(1){(w.scissors*100).toFixed(1)}%ã€çŸ³é ­ (w.rockâˆ—100).toFixed(1){(w.rock*100).toFixed(1)}%ã€å¸ƒ(w.rockâˆ—100).toFixed(1){(w.paper*100).toFixed(1)}%ã€‚`;
      }

      // ç´€éŒ„ log
      const t = new Date().toLocaleTimeString();
      historyLog.unshift(`tâ€”ä½ ï¼š{t} â€” ä½ ï¼štâ€”ä½ ï¼š{labels[playerMove]}ï¼Œé›»è…¦ï¼šlabels[compMove]â†’{labels[compMove]} â†’labels[compMove]â†’{outcome === 'win' ? 'ä½ è´' : outcome === 'lose' ? 'ä½ è¼¸' : 'å¹³æ‰‹'}`);
      if (historyLog.length > 300) historyLog.pop();
      renderLog();
    }

    function renderLog() {
      logEl.innerHTML = '<div class="small">éŠæˆ²ç´€éŒ„ï¼ˆæœ€è¿‘è¨˜éŒ„ï¼‰</div>';
      for (const line of historyLog) {
        const d = document.createElement('div');
        d.textContent = line;
        logEl.appendChild(d);
      }
    }

    // ç¶å®š UI
    document.querySelectorAll('.choice-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const mv = btn.getAttribute('data-move');
        playRound(mv);
      });
    });

    applyBtn.addEventListener('click', () => {
      const na = parseFloat(alphaInput.value);
      const ne = parseFloat(epsilonInput.value);
      const nm = parseInt(maxHistInput.value, 10);
      const mode = responseModeEl.value;
      if (isNaN(na) || na < 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Î±ï¼ˆ>=0ï¼‰'); return; }
      if (isNaN(ne) || ne < 0 || ne > 1) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Îµï¼ˆ0~1ï¼‰'); return; }
      if (!Number.isInteger(nm) || nm < 10) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æœ€å¤§è¨˜éŒ„é•·åº¦ï¼ˆ>=10ï¼‰'); return; }
      alpha = na; epsilon = ne; maxHist = nm; responseMode = mode;
      alert(`å·²å¥—ç”¨ï¼šÎ±=alpha,Îµ={alpha}, Îµ=alpha,Îµ={epsilon}, maxHist=maxHist,mode={maxHist}, mode=maxHist,mode={responseMode}`);
    });

    resetBtn.addEventListener('click', () => {
      if (!confirm('ç¢ºå®šè¦é‡è¨­æ¯”åˆ†èˆ‡ AI ç´€éŒ„å—ï¼Ÿ')) return;
      playerScore = 0; computerScore = 0; drawScore = 0;
      playerHistory.length = 0; prevPlayer = null;
      for (const a of moves) for (const b of moves) transitionCounts[a][b] = 0;
      historyLog.length = 0;
      playerScoreEl.textContent = '0'; computerScoreEl.textContent = '0'; drawScoreEl.textContent = '0';
      roundInfoEl.textContent = 'å·²é‡è¨­';
      whoEl.textContent = ''; aiInfoEl.textContent = '';
      renderLog();
    });

    // åˆå§‹åŒ–
    renderLog();
  </script>
</body>
</html>

