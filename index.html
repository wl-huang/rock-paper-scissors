<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>çŒœæ‹³éŠæˆ² é€²éšç‰ˆ</title>
  <style>
    body { font-family: system-ui,"å¾®è»Ÿæ­£é»‘é«”"; background:#f6f8fa; margin:0; padding:1.2rem; color:#222; }
    .container { max-width:900px; margin:0 auto; background:#fff; padding:1.2rem; border-radius:10px; box-shadow:0 6px 18px rgba(30,30,30,0.06); }
    .hidden { display:none; }
    .choices { display:flex; gap:0.6rem; margin:1rem 0; }
    .choice-btn { flex:1; padding:0.8rem; border-radius:8px; border:1px solid #ddd; background:linear-gradient(#fff,#f2f4f7); cursor:pointer; font-size:1.05rem; font-weight:600; }
    .scoreboard { display:flex; gap:0.8rem; margin-top:1rem; }
    .score-box { flex:1; padding:0.6rem; border-radius:8px; background:#f8fafc; border:1px solid #eef2f7; text-align:center; }
    .result { margin-top:1rem; padding:0.75rem; border-radius:8px; border:1px dashed #e4e7eb; background:#fcfdff; }
    .small { font-size:0.85rem; color:#666; }
    .settings label { display:block; margin-top:0.4rem; font-size:0.9rem; color:#333; }
    .log { margin-top:1rem; max-height:220px; overflow:auto; padding:0.6rem; background:#fafafa; border-radius:8px; border:1px solid #eee; font-size:0.95rem; white-space:pre-wrap; }
    button { cursor:pointer; border-radius:6px; border:1px solid #ccc; background:#f9f9f9; padding:0.6rem 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>çŒœæ‹³éŠæˆ² é€²éšç‰ˆ</h1>

    <div id="setup">
      <p class="small">è¨­å®šåƒæ•¸å¾Œé–‹å§‹éŠæˆ²ã€‚</p>
      <div class="settings">
        <label>å¹³æ»‘ Î±ï¼š<input id="alpha" type="number" step="0.1" min="0" value="0.05"></label>
        <label>æ¢ç´¢ç‡ Îµï¼š<input id="epsilon" type="number" step="0.01" min="0" max="1" value="0.12"></label>
        <label>è¨˜æ†¶ä¸Šé™ï¼š<input id="maxHist" type="number" min="10" value="200"></label>
        <label>å›æ‡‰æ¨¡å¼ï¼š
          <select id="responseMode">
            <option value="mixed">æ··åˆå›æ‡‰</option>
            <option value="max">ç¡¬æ€§ååˆ¶</option>
          </select>
        </label>
        <button id="startBtn">é–‹å§‹</button>
      </div>
    </div>

    <div id="game" class="hidden">
      <div class="choices">
        <button class="choice-btn" data-move="scissors">âœŒï¸ å‰ªåˆ€</button>
        <button class="choice-btn" data-move="rock">ğŸª¨ çŸ³é ­</button>
        <button class="choice-btn" data-move="paper">ğŸ§» å¸ƒ</button>
      </div>

      <div class="result">
        <div id="roundInfo">å°šæœªé–‹å§‹</div>
        <div id="who" style="font-weight:700;margin-top:0.4rem;"></div>
        <div id="aiInfo" style="margin-top:0.5rem;font-size:0.95rem;color:#333;"></div>
      </div>

      <div class="scoreboard">
        <div class="score-box"><div class="small">ä½ </div><div id="playerScore" style="font-size:1.3rem;font-weight:700;">0</div></div>
        <div class="score-box"><div class="small">å¹³æ‰‹</div><div id="drawScore" style="font-size:1.3rem;font-weight:700;">0</div></div>
        <div class="score-box"><div class="small">é›»è…¦</div><div id="computerScore" style="font-size:1.3rem;font-weight:700;">0</div></div>
      </div>

      <button id="resetBtn" style="margin-top:0.8rem;">é‡è¨­</button>
      <div class="log" id="log"><div class="small">éŠæˆ²ç´€éŒ„ï¼ˆæœ€è¿‘ï¼‰</div></div>
    </div>
  </div>

  <script>
    const moves = ['scissors','rock','paper'];
    const labels = { scissors:'å‰ªåˆ€ âœŒï¸', rock:'çŸ³é ­ ğŸª¨', paper:'å¸ƒ ğŸ§»' };
    const counter = { scissors:'rock', rock:'paper', paper:'scissors' };

    // åƒæ•¸èˆ‡ç‹€æ…‹
    let alpha=0.05, epsilon=0.12, maxHist=200, responseMode='mixed';
    let decayFactor=0.98, repeatThreshold=3, exploitLoseThreshold=3, exploitEpsilon=0.3, exploitEpsilonRounds=5;
    let exploitCounter=0, loseStreak=0, playerHistory=[], playerScore=0, computerScore=0, drawScore=0;
    let trans1, trans2, historyLog=[];

    const el = n=>document.getElementById(n);

    function resetCounts(){
      trans1={scissors:{scissors:0,rock:0,paper:0},rock:{scissors:0,rock:0,paper:0},paper:{scissors:0,rock:0,paper:0}};
      trans2={};
    }

    function resetAll(){
      playerHistory=[]; playerScore=computerScore=drawScore=0; historyLog=[];
      loseStreak=exploitCounter=0; resetCounts();
      el('playerScore').textContent='0';
      el('computerScore').textContent='0';
      el('drawScore').textContent='0';
      el('roundInfo').textContent='å·²é‡è¨­';
      el('who').textContent=''; el('aiInfo').textContent='';
      renderLog();
    }

    el('startBtn').addEventListener('click',()=>{
      alpha=parseFloat(el('alpha').value);
      epsilon=parseFloat(el('epsilon').value);
      maxHist=parseInt(el('maxHist').value,10);
      responseMode=el('responseMode').value;
      resetAll(); el('setup').classList.add('hidden'); el('game').classList.remove('hidden');
    });

    el('resetBtn').addEventListener('click',()=>resetAll());

    function randomMove(){ return moves[Math.floor(Math.random()*3)]; }

    function decayCounts(){
      for(let p of moves) for(let q of moves){
        trans1[p][q]*=decayFactor;
      }
      for(let k in trans2){
        for(let m of moves) trans2[k][m]*=decayFactor;
      }
    }

    function getFirstOrderProbs(prev){
      const c=trans1[prev]; let s=0,p={};
      for(let m of moves){ p[m]=(c[m]||0)+alpha; s+=p[m]; }
      for(let m of moves) p[m]/=s; return p;
    }

    function getSecondOrderProbs(p2,p1){
      const key=p2+'|'+p1; const c=trans2[key]||{scissors:0,rock:0,paper:0};
      let s=0,p={}; for(let m of moves){ p[m]=(c[m]||0)+alpha; s+=p[m]; }
      for(let m of moves) p[m]/=s; return p;
    }

    function aiChoose(){
      const n=playerHistory.length;
      let effEpsilon=epsilon;
      if(loseStreak>=exploitLoseThreshold){ effEpsilon=exploitEpsilon; exploitCounter=exploitEpsilonRounds; loseStreak=0; }
      if(exploitCounter>0){ effEpsilon=exploitEpsilon; exploitCounter--; }

      if(n<2 || Math.random()<effEpsilon) return {move:randomMove(),mode:'random'};

      const prev1=playerHistory[n-1], prev2=playerHistory[n-2];
      const key=prev2+'|'+prev1;
      const pairExists=trans2[key] && (trans2[key].scissors+trans2[key].rock+trans2[key].paper>0);
      const probs=pairExists?getSecondOrderProbs(prev2,prev1):getFirstOrderProbs(prev1);
      let finalMove;

      // è‹¥ç©å®¶é€£çºŒå‡ºåŒæ‰‹ï¼ŒAI å˜—è©¦ååˆ¶
      let repeatCount=1;
      for(let i=n-2;i>=0&&playerHistory[i]===prev1;i--) repeatCount++;
      if(repeatCount>=repeatThreshold){
        finalMove=counter[prev1];
        return {move:finalMove,mode:'pattern',probs:probs};
      }

      if(responseMode==='max'){
        let maxP=-1,cands=[];
        for(let m of moves){
          if(probs[m]>maxP){maxP=probs[m];cands=[m];}
          else if(probs[m]===maxP)cands.push(m);
        }
        const predicted=cands[Math.floor(Math.random()*cands.length)];
        finalMove=counter[predicted];
        return {move:finalMove,mode:'max',probs:probs,predicted:predicted};
      }else{
        const w={scissors:0,rock:0,paper:0};
        for(let pm of moves) w[counter[pm]]+=probs[pm];
        const r=Math.random(); let cum=0;
        for(let m of moves){ cum+=w[m]; if(r<=cum)return{move:m,mode:'mixed',probs:probs,aiWeights:w}; }
        return {move:randomMove(),mode:'mixed',probs:probs,aiWeights:w};
      }
    }

    function updateCounts(p2,p1,c){
      if(p1) trans1[p1][c]=(trans1[p1][c]||0)+1;
      if(p2&&p1){
        const k=p2+'|'+p1;
        if(!trans2[k]) trans2[k]={scissors:0,rock:0,paper:0};
        trans2[k][c]=(trans2[k][c]||0)+1;
      }
    }

    function decideOutcome(p,c){
      if(p===c) return 'draw';
      const winPairs={scissors:'paper',rock:'scissors',paper:'rock'};
      return winPairs[p]===c?'win':'lose';
    }

    function playRound(playerMove){
      decayCounts();
      const aiDec=aiChoose();
      const compMove=aiDec.move;
      const n=playerHistory.length;
      const p1=n>=1?playerHistory[n-1]:null;
      const p2=n>=2?playerHistory[n-2]:null;
      updateCounts(p2,p1,playerMove);
      playerHistory.push(playerMove);
      if(playerHistory.length>maxHist)playerHistory.shift();

      const outcome=decideOutcome(playerMove,compMove);
      if(outcome==='win'){playerScore++;loseStreak=0;}
      else if(outcome==='lose'){computerScore++;loseStreak++;}
      else drawScore++;
      el('playerScore').textContent=playerScore;
      el('computerScore').textContent=computerScore;
      el('drawScore').textContent=drawScore;

      el('roundInfo').textContent=`ä½ å‡º ${labels[playerMove]}ï¼Œé›»è…¦å‡º ${labels[compMove]}ã€‚`;
      el('who').textContent=outcome==='win'?'ä½ è´äº†':outcome==='lose'?'ä½ è¼¸äº†':'å¹³æ‰‹';
      el('who').style.color=outcome==='win'?'#0b8457':outcome==='lose'?'#c62828':'#444';

      if(aiDec.mode==='random'){ el('aiInfo').textContent='AI ä½¿ç”¨éš¨æ©Ÿç­–ç•¥ã€‚'; }
      else if(aiDec.mode==='pattern'){ el('aiInfo').textContent='AI åµæ¸¬åˆ°é‡è¤‡å‡ºæ‹³ï¼Œæ¡å–ååˆ¶ã€‚'; }
      else if(aiDec.mode==='max'){
        const p=aiDec.probs;
        el('aiInfo').textContent=`ç©å®¶æ©Ÿç‡ï¼šå‰ªåˆ€ ${(p.scissors*100).toFixed(1)}%ã€çŸ³é ­ ${(p.rock*100).toFixed(1)}%ã€å¸ƒ ${(p.paper*100).toFixed(1)}%ã€‚`;
      }else{
        const p=aiDec.probs,w=aiDec.aiWeights;
        el('aiInfo').textContent=`ç©å®¶æ©Ÿç‡ï¼šå‰ªåˆ€ ${(p.scissors*100).toFixed(1)}%ã€çŸ³é ­ ${(p.rock*100).toFixed(1)}%ã€å¸ƒ ${(p.paper*100).toFixed(1)}%ï¼›AI æ¬Šé‡ï¼šå‰ªåˆ€ ${(w.scissors*100).toFixed(1)}%ã€çŸ³é ­ ${(w.rock*100).toFixed(1)}%ã€å¸ƒ ${(w.paper*100).toFixed(1)}%ã€‚`;
      }

      const t=new Date().toLocaleTimeString();
      historyLog.unshift(`${t} â€” ä½ ï¼š${labels[playerMove]}ï¼Œé›»è…¦ï¼š${labels[compMove]} â†’ ${outcome==='win'?'ä½ è´':outcome==='lose'?'ä½ è¼¸':'å¹³æ‰‹'}`);
      if(historyLog.length>300)historyLog.pop();
      renderLog();
    }

    function renderLog(){
      const log=el('log');
      log.innerHTML='<div class="small">éŠæˆ²ç´€éŒ„ï¼ˆæœ€è¿‘ï¼‰</div>';
      for(const d of historyLog){ const div=document.createElement('div'); div.textContent=d; log.appendChild(div); }
    }

    document.querySelectorAll('.choice-btn').forEach(b=>{
      b.addEventListener('click',()=>playRound(b.getAttribute('data-move')));
    });

    resetAll();
  </script>
</body>
</html>
